{{#Master Master.html}}

{{#Script}}
<script src="{{#Url SharedContent/ansi_up.js}}"></script>
<script>
    var outputStreamUrl = '{{#Url api/build/output-stream}}?project={{&ProjectId}}&number={{&BuildNumber}}';

    $(function () {
        $('#layoutNavbarContent [data-link="builds"]').addClass('active');

        loadOutput();
    });

    function loadOutput() {
        $.ajax({
            url: outputStreamUrl,
            dataType: 'text'
        }).done(function(data) {
            onAppend(data);
        }).fail(function() {
            alert("Failed to load build output!");
        });
    }

    function onAppend(text) {
        var text_out = ansi_up.escape_for_html(text);
        text_out = ansi_up.ansi_to_html(text_out);
        //text_out = ansi_up.linkify(text_out);

        $('#OutputText').append(text_out);
    }
</script>
{{#EndScript}}

{{#Style}}
<style>
    #OutputText {
        overflow-x: auto;
        background: #111;
        color: #CCC;
        height: 85vh;
    }
    td.c-icon {
        width: 1px;
        white-space: nowrap;
    }
</style>
{{#EndStyle}}

<div class="bg-secondary mb-4 px-2 py-1">
    <h2 class="text-light my-0">Build Details <small>{{ProjectName}} #{{BuildNumber}}</small></h2>
</div>

<div class="container">
    {{#If Errors}}
    <div class="alert alert-danger">
        <ul>
            {{#Each Errors.error}}
            <li>{{error.Message}}</li>
            {{#EndEach}}
        </ul>
    </div>
    {{#EndIf}}

    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li id="SummaryTabLink" class="nav-item">
                    <a class="nav-link active" href="#summary" data-toggle="tab" role="tab">Summary</a>
                </li>
                <li id="OutputTabLink" class="nav-item">
                    <a class="nav-link" href="#output" data-toggle="tab" role="tab">Output</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <div id="summary" class="tab-pane fade show active" role="tabpanel">
                    {{#If IsRunning}}
                    <div class="alert alert-info">
                        <h4><i class="fas fa-spinner fa-spin"></i> Build is running...</h4>
                    </div>
                    {{#Else}}
                    <table class="table table-sm">
                        <tbody>
                        <tr>
                            <td>Project</td>
                            <td>{{ProjectName}}</td>
                        </tr>
                        <tr>
                            <td>Number</td>
                            <td>{{BuildNumber}}</td>
                        </tr>
                        <tr>
                            <td>Created</td>
                            <td>{{BuildCreated}}</td>
                        </tr>
                        <tr>
                            <td>Duration</td>
                            <td>{{BuildDuration}}</td>
                        </tr>
                        </tbody>
                    </table>
                    <table class="table table-sm table-hover mt-4">
                        <thead>
                        <tr>
                            <th colspan="2">Packages</th>
                        </tr>
                        </thead>
                        <tbody>
                        {{#If ProjectPackages}}
                            {{#Each ProjectPackages.package}}
                            <tr>
                                <td>{{package.PackageId}} <span class="text-muted">@</span>{{package.PackageVersion}}</td>
                                <td class="c-icon">
                                    <a href="#" class="btn btn-sm btn-primary">
                                        <i class="fas fa-play"></i>
                                    </a>
                                </td>
                            </tr>
                            {{#EndEach}}
                        {{#Else}}
                        <tr>
                            <td class="text-center text-muted">
                                None
                            </td>
                        </tr>
                        {{#EndIf}}
                        </tbody>
                    </table>
                    {{#EndIf}}
                </div>
                <div id="output" class="tab-pane fade" role="tabpanel">
                    {{#If IsRunning}}
                    <div class="alert alert-info">
                        <h4><i class="fas fa-spinner fa-spin"></i> Build is running...</h4>
                    </div>
                    {{#Else}}
                    <pre id="OutputText" class="rounded px-2 py-1"></pre>
                    {{#EndIf}}
                </div>
            </div>
        </div>
    </div>
</div>